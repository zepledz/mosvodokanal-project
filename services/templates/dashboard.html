<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–æ—Å–≤–æ–¥–æ–∫–∞–Ω–∞–ª - –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤–æ–¥–æ—Å–Ω–∞–±–∂–µ–Ω–∏—è</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            text-align: center;
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            color: #7f8c8d;
            font-size: 1.2em;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: center;
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card.total { border-left: 5px solid #3498db; }
        .stat-card.normal { border-left: 5px solid #2ecc71; }
        .stat-card.anomaly { border-left: 5px solid #e74c3c; }
        .stat-card.percentage { border-left: 5px solid #f39c12; }

        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            margin: 10px 0;
        }

        .stat-label {
            color: #7f8c8d;
            font-size: 1.1em;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            border-left: 5px solid #2ecc71;
        }

        .card.anomaly {
            border-left-color: #e74c3c;
            background: linear-gradient(135deg, #fff 0%, #ffebee 100%);
        }

        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .card-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 15px;
        }

        .address {
            font-weight: bold;
            color: #2c3e50;
            font-size: 1.1em;
            flex: 1;
        }

        .status {
            font-size: 1.5em;
            padding: 5px 10px;
            border-radius: 20px;
            background: #ecf0f1;
        }

        .status.anomaly {
            background: #ffebee;
            color: #e74c3c;
        }

        .measurements {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .measurement {
            text-align: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .measurement-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #2c3e50;
        }

        .measurement-label {
            color: #7f8c8d;
            font-size: 0.9em;
        }

        .deviation {
            text-align: center;
            padding: 10px;
            background: #fff3cd;
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .deviation.high {
            background: #f8d7da;
            color: #721c24;
        }

        .timestamp {
            color: #95a5a6;
            font-size: 0.8em;
            text-align: center;
            margin-top: 10px;
        }

        .last-update {
            text-align: center;
            color: #7f8c8d;
            margin-top: 20px;
            font-style: italic;
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè¢ –ú–æ—Å–≤–æ–¥–æ–∫–∞–Ω–∞–ª</h1>
            <p>–°–∏—Å—Ç–µ–º–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Ä–∞—Å—Ö–æ–¥–∞ –•–í–° –∏ –ì–í–° –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏</p>
        </div>

        <div class="stats-grid">
            <div class="stat-card total">
                <div class="stat-label">–í—Å–µ–≥–æ –∑–¥–∞–Ω–∏–π</div>
                <div class="stat-value" id="total-buildings">0</div>
            </div>
            <div class="stat-card normal">
                <div class="stat-label">–ù–æ—Ä–º–∞–ª—å–Ω—ã–µ –ø–æ–∫–∞–∑–∞–Ω–∏—è</div>
                <div class="stat-value" id="normal-count">0</div>
            </div>
            <div class="stat-card anomaly">
                <div class="stat-label">–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –∞–Ω–æ–º–∞–ª–∏–π</div>
                <div class="stat-value" id="anomaly-count">0</div>
            </div>
            <div class="stat-card percentage">
                <div class="stat-label">–ü—Ä–æ—Ü–µ–Ω—Ç –∞–Ω–æ–º–∞–ª–∏–π</div>
                <div class="stat-value" id="anomaly-percentage">0%</div>
            </div>
        </div>

        <h2 style="color: white; margin-bottom: 20px; text-align: center;">üìä –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø–æ–∫–∞–∑–∞–Ω–∏—è</h2>

        <div class="dashboard" id="dashboard">
            <div style="grid-column: 1 / -1; text-align: center; color: white; padding: 40px;">
                –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...
            </div>
        </div>

        <div class="last-update" id="last-update">
            –ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: –∑–∞–≥—Ä—É–∑–∫–∞...
        </div>
    </div>

    <script>
        const socket = io();

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞—á–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        socket.on('initial_data', function(data) {
            updateDashboard(data.data);
            updateStats(data.stats);
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        socket.on('new_data', function(data) {
            updateDashboard(data.data);
            updateStats(data.stats);
        });

        function updateDashboard(data) {
            const dashboard = document.getElementById('dashboard');

            if (data.length === 0) {
                dashboard.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; color: white; padding: 40px;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</div>';
                return;
            }

            dashboard.innerHTML = data.map(item => `
                <div class="card ${item.status === 'üö®' ? 'anomaly' : ''}">
                    <div class="card-header">
                        <div class="address">${item.address}</div>
                        <div class="status ${item.status === 'üö®' ? 'anomaly' : ''}">${item.status}</div>
                    </div>

                    <div class="measurements">
                        <div class="measurement">
                            <div class="measurement-value">${item.cold_water.toFixed(1)}</div>
                            <div class="measurement-label">–•–í–° (–ª)</div>
                        </div>
                        <div class="measurement">
                            <div class="measurement-value">${item.hot_water.toFixed(1)}</div>
                            <div class="measurement-label">–ì–í–° (–ª)</div>
                        </div>
                    </div>

                    <div class="deviation ${item.deviation > 10 ? 'high' : ''}">
                        –û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ: <strong>${item.deviation.toFixed(1)}%</strong>
                    </div>

                    <div class="timestamp">
                        ${new Date(item.timestamp).toLocaleString('ru-RU')}
                    </div>
                </div>
            `).join('');
        }

        function updateStats(stats) {
            document.getElementById('total-buildings').textContent = stats.total_buildings;
            document.getElementById('normal-count').textContent = stats.normal;
            document.getElementById('anomaly-count').textContent = stats.anomalies;
            document.getElementById('anomaly-percentage').textContent = stats.anomaly_percentage + '%';
            document.getElementById('last-update').textContent =
                '–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: ' + new Date(stats.last_update).toLocaleString('ru-RU');
        }

        // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ API (fallback)
        function fetchData() {
            fetch('/api/data')
                .then(response => response.json())
                .then(data => updateDashboard(data));

            fetch('/api/stats')
                .then(response => response.json())
                .then(stats => updateStats(stats));
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥ –Ω–∞ —Å–ª—É—á–∞–π –ø—Ä–æ–±–ª–µ–º —Å WebSocket
        setInterval(fetchData, 30000);

        // –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
        fetchData();
    </script>
</body>
</html>